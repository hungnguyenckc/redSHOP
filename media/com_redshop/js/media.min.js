var rsMedia={url:"index.php?option=com_redshop&view=media&task=ajaxUpload",delUrl:"index.php?option=com_redshop&view=media&task=ajaxDelete",dropzoneFromHtml:$("#j-dropzone-form").html(),dropzoneInstance:{},galleryItems:[],cropping:function(d){$(document).on("click","button.rs-media-cropping",function(e){e.preventDefault();var a,n,t,i,o=d.files[0];if(!o)return $("#alertModal").find(".alert-text").text("Please insert an image!!!"),void $("#alertModal").modal("show");o.width<100||(a=o.name,e=(n=$("#cropModal")).find(".crop-upload"),t=$("<img />"),(i=new FileReader).onloadend=function(){t.attr("src",i.result),n.find(".image-container").html(t),t.cropper({dragMode:"move",autoCropArea:.5,movable:!1,cropBoxResizable:!0,minContainerWidth:320,minContainerHeight:320,viewMode:3,zoomable:!1})},o.preload?i.readAsDataURL(rsMedia.dataURItoBlob(o.blob)):i.readAsDataURL(o),e.off("click"),n.modal("show"),n.trigger("resize"),console.log("abc"),e.on("click",function(){var e=t.cropper("getCroppedCanvas").toDataURL(),e=rsMedia.dataURItoBlob(e);e.cropped=!0,e.name=a,console.log(a),console.log(e),d.removeFile(o),d.addFile(e),n.modal("hide")}))})},dropzone:function(){Dropzone.autoDiscover=!1,$("body").append(this.dropzoneFromHtml),$("#j-dropzone").length&&(this.dropzoneInstance=new Dropzone("#j-dropzone",{url:rsMedia.url,autoProcessQueue:!0,thumbnailWidth:null,thumbnailHeight:null,previewTemplate:$("#j-dropzone-tpl").html()}),this.dropzoneEvents(this.dropzoneInstance),this.cropping(this.dropzoneInstance))},dropzoneEvents:function(n){n.on("addedfile",function(e){return e.type.indexOf("image/")<0?(this.removeFile(e),$("#alertModal").find(".alert-text").text("You can not upload this type of file!"),void $("#alertModal").modal("show")):(1<this.files.length&&this.removeFile(this.files[0]),$("#j-dropzone").parent().find(".btn.rs-media-removing").removeClass("disabled").prop("disabled",!1),void $("#j-dropzone").parent().find(".btn.rs-media-cropping").removeClass("disabled").prop("disabled",!1))}),n.on("success",function(e,a){(a=JSON.parse(a)).success&&$(".img-select").val(a.data.file.url)}),$(document).on("click","button.rs-media-removing",function(e){var a;n.removeAllFiles(),$(".img-select").val(""),$("#j-dropzone").parent().find(".btn.rs-media-removing").addClass("disabled").prop("disabled",!0),$("#j-dropzone").parent().find(".btn.rs-media-cropping").addClass("disabled").prop("disabled",!0),$("#image_delete").length<=0&&((a=$("<input/>")).attr("id","image_delete").attr("name","image_delete").attr("type","hidden").val(!0),$("#adminForm").append(a[0]))})},dropzonePreload:function(e,a){a&&(newfile=rsMedia.dataURItoBlob(a.blob),newfile.name=a.name,e.emit("thumbnail",a,a.url),e.addFile(newfile))},dataURItoBlob:function(e){for(var a=atob(e.split(",")[1]),e=new ArrayBuffer(a.length),n=new Uint8Array(e),t=0;t<a.length;t++)n[t]=a.charCodeAt(t);return new Blob([e],{type:"image/jpg"})},init:function(){$.fn.modalmanager.defaults.backdropLimit=1,this.dropzone(),this.galleryEvents()},galleryDropzone:function(){var e;$("#g-dropzone").length&&(e=new Dropzone("#g-dropzone",{url:rsMedia.url,maxFiles:1,thumbnailWidth:null,thumbnailHeight:null,previewTemplate:$("#g-dropzone-tpl").html()}),this.galleryDropzoneEvents(e))},galleryEvents:function(i){void 0!==i&&""!=i||(i="galleryModal"),$(".choosing").on("click",function(e){e.preventDefault(),$("#"+i).modal("show")}),$(document).on("click","#"+i+" .img-obj",function(e){e.preventDefault(),$(this).hasClass("selected")?$(this).removeClass("selected"):($("#"+i+" .img-obj").removeClass("selected"),$(this).addClass("selected"),rsMedia.showInfoThumbnail(this)),rsMedia.resetInfoThumbnail(),rsMedia.toggleInsert()}),$("#"+i+" #type-filter").on("change",function(e){var a=$(this).val();"all"!=a?"attached"!=a?($("#"+i+" .img-obj > img:not([data-media="+a+"])").parent().parent().addClass("hidden"),$("#"+i+" .img-obj > img[data-media="+a+"]").parent().parent().removeClass("hidden")):$("#"+i+" .img-obj > img:not([data-attached=true])").parent().parent().addClass("hidden"):$("#"+i+" .img-obj").parent().removeClass("hidden")}),$("#"+i+" .btn-insert").on("click",function(e){e.preventDefault();var n=$("#"+i+" .img-obj.selected").find("img").first(),e=n.attr("src");$("#"+i+" .img-select").val(e);var t=new XMLHttpRequest;t.open("GET",e),t.responseType="blob",t.send(),t.addEventListener("load",function(){var a=new FileReader;a.readAsDataURL(t.response),a.addEventListener("loadend",function(){var e=rsMedia.dataURItoBlob(a.result);e.name=n.attr("alt"),rsMedia.dropzoneInstance.addFile(e),$("#"+i).modal("hide")})})}),$("#"+i+" .btn-del-g").on("click",function(e){e.preventDefault(),$("#"+i+"Delete .btn-confirm-del-g").data("id",$(this).data("id")),$("#"+i+"Delete").modal("show")}),$("#"+i+"Delete .btn-confirm-del-g").on("click",function(e){e.preventDefault(),console.log("abc");e=$(this).data("id");e&&$.ajax({url:rsMedia.delUrl,method:"post",data:{id:e}}).done(function(e){$("#"+i).find(".img-obj.selected").parent().remove(),$("#"+i+" .pv-wrapper").addClass("hidden")}).always(function(e){$("#"+i+"Delete").modal("hide")})})},galleryDropzoneEvents:function(t){t.on("sending",function(e,a,n){n.append("new",!0)}),t.on("success",function(e,a){var e=(a=JSON.parse(a)).data.file,n=$("#g-item-tpl").html(),a=$(n),n={};(n="image"==e.mime?(a.find("span.img-type").remove(),a.find("img.img-type")):(a.find("img.img-type").remove(),a.find("span.img-type"))).attr("src","/"+e.url),n.attr("alt",e.name),n.data("id",e.id),n.data("size",e.size),n.data("dimension",e.dimension),n.data("media",e.media),a.find(".img-mime").data("mime",e.mime),""!=e.mime&&(n.find("i.fa").removeClass("fa-file-o").addClass("fa-file-"+e.mime+"-o"),a.find(".img-mime i.fa").removeClass("fa-file-o").addClass("fa-file-"+e.mime+"-o")),a.find(".img-name").text(e.name),$("#upload-lib .list-pane").append(a[0]),$('#g-tab a[href="#upload-lib"]').tab("show"),t.removeAllFiles()})},showInfoThumbnail:function(e){var a=$(e).find(".img-type"),e={id:a.data("id"),url:a.attr("src"),name:a.attr("alt"),size:a.data("size"),dimension:a.data("dimension")};$img=a.clone();a=$(".preview-pane");a.find(".pv-img .img-type").remove(),a.find(".pv-img").append($img),a.find(".pv-zoom").attr("href",e.url),a.find(".pv-zoom").attr("data-title",e.name),a.find(".pv-link").attr("href",e.url),a.find(".pv-name").text(e.name),a.find(".pv-size").text(e.size),a.find(".pv-dimension").text(e.dimension),a.find(".pv-url").html('<input type="text" value="'+e.url+'" class="form-control" readonly="true">'),a.find(".pv-remove > a").data("id",e.id),a.find(".pv-wrapper").removeClass("hidden")},resetInfoThumbnail:function(){var e=$(".preview-pane");$(".img-obj.selected").length<=0&&e.find(".pv-wrapper").addClass("hidden")},toggleInsert:function(){0<$(".img-obj.selected").length?$(".btn-insert").removeAttr("disabled"):$(".btn-insert").attr("disabled","true")}};