!function(a){var t="redshopMedia",n={uploadUrl:"index.php?option=com_redshop&view=media&task=ajaxUpload",deleteUrl:"index.php?option=com_redshop&view=media&task=ajaxDelete",allowedMime:"image/jpeg,image/jpg,image/png,image/gif",maxFileSize:2048,imageMaxWidth:2048,imageMaxHeight:2048,initFile:null,showMediaFiles:!1};function i(e,i){this._name=t,this._defaults=n,this.element=e,this.options=a.extend({},n,i),this.token=null,this.dropzoneInstance=null,this.$container=a(e),this.$dropzonePreview=this.$container.find(".rs-media-dropzone-preview"),this.$dropzoneForm=this.$container.find(".rs-media-dropzone-form"),this.$form=this.$container.closest("form"),this.$alertModal=this.$container.find(".rs-media-alert-modal"),this.$cropperModal=this.$container.find(".rs-media-cropper-modal"),this.$cropperButton=this.$container.find(".rs-media-cropper-btn"),this.$removeButton=this.$container.find(".rs-media-remove-btn"),this.$target=this.$container.find(".redshop-media-img-select"),this.$mediaFileButton=null,this.$mediaFileInsertButton=null,this.$mediaFileModal=null,this.$mediaFilePreview=null,this.$mediaFileDelModal=null,this.init()}i.prototype={init:function(){var e,i=this;this._initAttributes(),Dropzone.autoDiscover=!1,i.$dropzoneForm.length&&a("body").append(a(i.$dropzoneForm[0]).html()),a("#"+i.$container.data("id")+"-dropzone")&&(i.dropzoneInstance=new Dropzone("#"+i.$container.data("id")+"-dropzone",{url:i.options.uploadUrl,acceptedFiles:".png,.jpg,.jpeg,.bmp",autoProcessQueue:!0,thumbnailWidth:null,thumbnailHeight:null,previewTemplate:a(i.$dropzonePreview[0]).html(),resizeWidth:i.options.imageMaxWidth,resizeHeight:i.options.imageMaxHeight,resizeMethod:"contain"})),i.$alertModal.length&&(i.$alertModal=a(i.$alertModal[0])),i.$cropperButton.length&&(i.$cropperButton=a(i.$cropperButton[0])),i.$removeButton.length&&(i.$removeButton=a(i.$removeButton[0])),i.$target.length&&(i.$target=a(i.$target[0])),!0===i.options.showMediaFiles&&(i.$container.find(".rs-media-gallery-modal").length&&(i.$mediaFileModal=a(i.$container.find(".rs-media-gallery-modal")[0])),i.$container.find(".rs-media-gallery-preview").length&&(i.$mediaFilePreview=a(i.$container.find(".rs-media-gallery-preview")[0])),i.$container.find(".rs-media-gallery-delete-modal").length&&(i.$mediaFileDelModal=a(i.$container.find(".rs-media-gallery-delete-modal")[0])),i.$container.find(".rs-media-gallery-btn").length&&(i.$mediaFileButton=a(i.$container.find(".rs-media-gallery-btn")[0])),i.$container.find(".rs-media-gallery-insert-btn").length&&(i.$mediaFileInsertButton=a(i.$container.find(".rs-media-gallery-insert-btn")[0])),this._initMediaFileEvents()),this._initEvents(),null!=i.options.initFile&&((e=i.dataURItoBlob(i.options.initFile.blob)).name=i.options.initFile.name,i.dropzoneInstance.emit("thumbnail",i.options.initFile,i.options.initFile.url),i.dropzoneInstance.addFile(e))},_initAttributes:function(){this.token=this.$container.attr("data-token")},_initEvents:function(){var d=this;d.dropzoneInstance.on("addedfile",function(e){d.validateFile(e)?(1<this.files.length&&this.removeFile(this.files[0]),d.$cropperButton.removeClass("disabled").prop("disabled",!1),d.$removeButton.removeClass("disabled").prop("disabled",!1),d.$container.find("#rs-media-img-delete").length&&d.$container.find("#rs-media-img-delete").remove()):this.removeFile(e)}),d.dropzoneInstance.on("success",function(e,i){(i=JSON.parse(i)).success&&d.$target.val(i.data.file.url)}),d.$removeButton.on("click",function(e){e.preventDefault(),d.dropzoneInstance.removeAllFiles(),d.$target.val(""),d.$cropperButton.addClass("disabled").prop("disabled",!0),d.$removeButton.addClass("disabled").prop("disabled",!0),d.$container.find(".ui-corner-all").length<=0&&jQuery(".ui-corner-all").remove();e=null;d.$container.find("#rs-media-img-delete").length<=0&&((e=a("<input/>")).attr("id","rs-media-img-delete").attr("name",d.$container.data("id")+"_delete").attr("type","hidden"),a("#adminForm").append(e)),e.val(!0)}),d.$cropperButton.on("click",function(e){e.preventDefault();e=d.dropzoneInstance.files[0];e?e.width<100||d.$cropperModal.modal("show"):showAlert("Please insert an image!!!")}),d.$cropperModal.on("shown.bs.modal",function(e){var i=d.dropzoneInstance.files[0],t=i.name,n=d.$cropperModal.find(".crop-upload"),a=d.$cropperModal.find(".image-container img").first(),o=new FileReader;o.onloadend=function(){a.attr("src",o.result),a.cropper("destroy").cropper({dragMode:"move",autoCropArea:.5,movable:!1,cropBoxResizable:!0,viewMode:2,zoomable:!0})},i.preload?o.readAsDataURL(d.dataURItoBlob(i.blob)):o.readAsDataURL(i),n.off("click"),n.on("click",function(){var e=a.cropper("getCroppedCanvas").toDataURL(),e=d.dataURItoBlob(e);e.cropped=!0,e.name=t,d.dropzoneInstance.removeFile(i),d.dropzoneInstance.addFile(e),d.$cropperModal.modal("hide")})})},_initMediaFileEvents:function(){var n=this;n.$mediaFileButton.click(function(e){e.preventDefault(),n.$mediaFileModal.modal("show")}),n.$mediaFileModal.find(".img-obj").click(function(e){e.preventDefault(),a(this).hasClass("selected")?a(this).removeClass("selected"):(n.$mediaFileModal.find(".img-obj").removeClass("selected"),a(this).addClass("selected"),n.mediaFileShowInfor(this)),n.mediaFileResetPreview(),n.mediaFileToggleInsert()}),n.$mediaFileInsertButton.click(function(e){e.preventDefault();var t=n.$mediaFileModal.find(".img-obj.selected").find("img").first(),i=t.attr("src");n.$target.val(i);e=new XMLHttpRequest;e.open("GET",i),e.responseType="blob",e.send(),e.addEventListener("load",function(){var i=new FileReader;i.readAsDataURL(this.response),i.addEventListener("loadend",function(){var e=n.dataURItoBlob(i.result);e.name=t.attr("alt"),n.dropzoneInstance.addFile(e),n.$mediaFileModal.modal("hide")})})}),n.$mediaFileModal.find(".btn-del-g").on("click",function(e){e.preventDefault(),n.$mediaFileDelModal.find(".btn-confirm-del-g").data("id",a(this).data("id")),n.$mediaFileDelModal.modal("show")}),n.$mediaFileDelModal.find(".btn-confirm-del-g").on("click",function(e){e.preventDefault();e=a(this).data("id");e&&a.ajax({url:n.options.deleteUrl,method:"post",data:{id:e}}).done(function(e){n.$mediaFileModal.find(".img-obj.selected").parent().remove(),n.$mediaFileModal.find(".pv-wrapper").addClass("hidden")}).always(function(e){n.$mediaFileDelModal.modal("hide")})})},validateFile:function(e){var i=this;return e.size/1024>i.options.maxFileSize?(i.showAlert(Joomla.JText._("COM_REDSHOP_UPLOAD_FILE_TOO_BIG")),!1):-1!=i.options.allowedMime.indexOf(e.type)||(i.showAlert(Joomla.JText._("COM_REDSHOP_MEDIA_ERROR_FILE_UPLOAD_INVALID")),!1)},showAlert:function(e){this.$alertModal.find(".alert-text").text(e),this.$alertModal.modal("show"),a("#toolbar-apply button, #toolbar-save button, #toolbar-save-new button, #toolbar-save-copy button").attr("disabled",!1)},dataURItoBlob:function(e){for(var i=atob(e.split(",")[1]),e=new ArrayBuffer(i.length),t=new Uint8Array(e),n=0;n<i.length;n++)t[n]=i.charCodeAt(n);return new Blob([e],{type:"image/jpg"})},mediaFileShowInfor:function(e){var i,t;this.$mediaFileModal.find(".preview-pane").length<=0||(i=a(this.$mediaFileModal.find(".preview-pane")[0]),e={id:(t=a(e).find(".img-type")).data("id"),url:t.attr("src"),name:t.attr("alt"),size:t.data("size"),dimension:t.data("dimension")},t=t.clone(),i.find(".pv-img .img-type").remove(),i.find(".pv-img").append(t),i.find(".pv-zoom").attr("href",e.url),i.find(".pv-zoom").attr("data-title",e.name),i.find(".pv-link").attr("href",e.url),i.find(".pv-name").text(e.name),i.find(".pv-size").text(e.size),i.find(".pv-dimension").text(e.dimension),i.find(".pv-url").html('<input type="text" value="'+e.url+'" class="form-control" readonly="true">'),i.find(".pv-remove > a").data("id",e.id),i.find(".pv-wrapper").removeClass("hidden"))},mediaFileResetPreview:function(){var e;this.$mediaFileModal.find(".preview-pane").length<=0||(e=a(this.$mediaFileModal.find(".preview-pane")[0]),this.$mediaFileModal.find(".img-obj.selected").length<=0&&e.find(".pv-wrapper").addClass("hidden"))},mediaFileToggleInsert:function(){null!=this.$mediaFileModal&&(0<this.$mediaFileModal.find(".img-obj.selected").length?this.$mediaFileInsertButton.removeAttr("disabled"):this.$mediaFileInsertButton.attr("disabled","true"))}},a.fn[t]=function(e){return this.each(function(){a.data(this,"plugin_"+t)||a.data(this,"plugin_"+t,new i(this,e))})}}(jQuery,(window,document));